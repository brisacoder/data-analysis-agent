
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pyodide: CSV + Python Script Runner</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    textarea { width: 100%; height: 200px; font-family: monospace; }
    pre { background: #f4f4f4; padding: 1rem; border-radius: 6px; white-space: pre-wrap; }
    img { max-width: 100%; border: 1px solid #ccc; margin-top: 1rem; }
  </style>
</head>
<body>
  <h2>Python in Browser (Pyodide): CSV + Code Upload</h2>

  <label>Upload CSV: <input type="file" id="csvFile" accept=".csv" /></label><br>
  <label>Upload Python Script (.py): <input type="file" id="pyFile" accept=".py" /></label><br><br>

  <textarea id="code"># Example Python code
import pandas as pd
import matplotlib.pyplot as plt
import io, base64

# Load uploaded CSV
df = pd.read_csv("/home/pyodide/upload.csv")
df.plot()

# Save plot to memory
buf = io.BytesIO()
plt.savefig(buf, format='png')
buf.seek(0)
b64 = base64.b64encode(buf.read()).decode('utf-8')</textarea><br>

  <button onclick="runCode()">Run Code</button>

  <h3>Output:</h3>
  <pre id="output">Initializing Pyodide...</pre>

  <h3>Plot:</h3>
  <img id="plot" alt="Your plot will appear here" />

  <script>
    let pyodideReady = false;
    let pyodide = null;

    async function main() {
      pyodide = await loadPyodide();
      await pyodide.loadPackage(["pandas", "matplotlib"]);
      await pyodide.runPythonAsync("import matplotlib; matplotlib.use('Agg')");
      pyodideReady = true;
      document.getElementById("output").textContent = "✅ Pyodide is ready.";
    }

    async function runCode() {
      if (!pyodideReady) return;

      const codeArea = document.getElementById("code");
      const output = document.getElementById("output");
      const img = document.getElementById("plot");
      const csvFile = document.getElementById("csvFile").files[0];
      const pyFile = document.getElementById("pyFile").files[0];

      try {
        // Load CSV file into FS
        if (csvFile) {
          const csvText = await csvFile.text();
          pyodide.FS.writeFile("/home/pyodide/upload.csv", csvText);
        }

        // If .py file was uploaded, override textarea content
        if (pyFile) {
          const pyText = await pyFile.text();
          codeArea.value = pyText;
        }

        await pyodide.runPythonAsync(codeArea.value);

        const b64 = pyodide.globals.get("b64");
        img.src = "data:image/png;base64," + b64;
        output.textContent = "✅ Code executed successfully.";
      } catch (err) {
        output.textContent = "❌ Error:\n" + err;
        img.src = "";
      }
    }

    main();
  </script>
</body>
</html>
