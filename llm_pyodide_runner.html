<!doctype html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.0/full/pyodide.js"></script>
    <style>
      body { 
        font-family: sans-serif; 
        margin: 2rem; 
        max-width: 1200px;
      }
      textarea { 
        width: 100%; 
        font-family: 'Courier New', monospace; 
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
      }
      button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .file-input {
        margin: 10px 0;
      }
      #output {
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }
      .status.loading {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .status.ready {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h1>Enhanced Python Runner with Pyodide</h1>
    
    <div id="status" class="status loading">Initializing Pyodide...</div>
    
    <h3>Python Code Editor</h3>
    <p>Enter your Python code below. You can use packages like pandas, numpy, matplotlib, etc.</p>
    
    <textarea id="code" rows="15" placeholder="Enter your Python code here...">
# Example: Working with data using built-in packages
import pandas as pd
import numpy as np

# Create sample data
data = {
    'Name': ['Alice', 'Bob', 'Charlie', 'Diana'],
    'Age': [25, 30, 35, 28],
    'Score': [85, 92, 78, 96]
}

df = pd.DataFrame(data)
print("Sample DataFrame:")
print(df)
print(f"\nAverage age: {df['Age'].mean()}")
print(f"Max score: {df['Score'].max()}")

# Example: Install a PyPI package (uncomment to try)
# await micropip.install("requests")
# import requests
# print("Requests package installed!")
    </textarea>
    
    <div>
      <button id="runButton" onclick="evaluatePython()" disabled>Run Python Code</button>
      <button onclick="clearOutput()">Clear Output</button>
    </div>
    
    <h3>Upload CSV File</h3>
    <div class="file-input">
      <input type="file" id="csvFile" accept=".csv" />
      <button onclick="loadCSV()">Load CSV into Pyodide</button>
    </div>
    <p><small>After uploading a CSV, you can access it in your Python code using: <code>pd.read_csv('uploaded_file.csv')</code></small></p>
    
    <h3>Output</h3>
    <textarea id="output" rows="20" disabled>Waiting for Pyodide to initialize...\n</textarea>

    <script>
      const output = document.getElementById("output");
      const code = document.getElementById("code");
      const status = document.getElementById("status");
      const runButton = document.getElementById("runButton");
      
      function addToOutput(s) {
        output.value += ">>> " + code.value.split('\n')[0] + (code.value.split('\n').length > 1 ? "..." : "") + "\n" + s + "\n\n";
        output.scrollTop = output.scrollHeight;
      }
      
      function clearOutput() {
        output.value = "";
      }
      
      function updateStatus(message, type = 'loading') {
        status.textContent = message;
        status.className = `status ${type}`;
      }
      
      // Initialize Pyodide
      async function main() {
        try {
          updateStatus("Loading Pyodide...", 'loading');
          let pyodide = await loadPyodide();
          
          updateStatus("Loading built-in packages...", 'loading');
          // Load packages that are built into Pyodide
          await pyodide.loadPackage(["numpy", "pandas", "matplotlib", "scipy", "micropip"]);
          
          updateStatus("Setting up package management...", 'loading');
          // Set up micropip for additional package installation
          await pyodide.runPythonAsync(`
import micropip
import sys
import io

# Redirect stdout to capture print statements
sys.stdout = io.StringIO()

# Make micropip available globally for user code that needs PyPI packages
globals()['micropip'] = micropip

# Import commonly used packages
import numpy as np
import pandas as pd
try:
    import matplotlib.pyplot as plt
    import matplotlib
    matplotlib.use('Agg')  # Use non-interactive backend
except ImportError:
    pass

print("Available packages:")
print("- numpy (as np)")
print("- pandas (as pd)")  
print("- matplotlib.pyplot (as plt)")
print("- scipy")
print('- Use "await micropip.install(\\'package_name\\')" for PyPI packages')
          `);
          
          updateStatus("Pyodide ready! You can now run Python code.", 'ready');
          runButton.disabled = false;
          output.value = "Pyodide initialized successfully!\n\n";
          
          return pyodide;
        } catch (error) {
          updateStatus(`Failed to initialize Pyodide: ${error}`, 'error');
          addToOutput(`Initialization Error: ${error}`);
          throw error;
        }
      }
      
      let pyodideReadyPromise = main();
      
      async function evaluatePython() {
        try {
          runButton.disabled = true;
          runButton.textContent = "Running...";
          
          let pyodide = await pyodideReadyPromise;
          
          // Clear previous stdout
          pyodide.runPython(`
import sys
import io
sys.stdout = io.StringIO()
          `);
          
          let result;
          const userCode = code.value;
          
          // Check if code contains async operations
          if (userCode.includes('await ') || userCode.includes('micropip.install')) {
            result = await pyodide.runPythonAsync(userCode);
          } else {
            result = pyodide.runPython(userCode);
          }
          
          // Get captured stdout
          const stdout = pyodide.runPython("sys.stdout.getvalue()");
          
          // Display output
          let outputText = "";
          if (stdout) {
            outputText += stdout;
          }
          if (result !== undefined && result !== null && result !== "") {
            outputText += (outputText ? "\nReturn value: " : "") + result;
          }
          
          addToOutput(outputText || "Code executed successfully (no output)");
          
        } catch (err) {
          addToOutput(`Error: ${err}`);
        } finally {
          runButton.disabled = false;
          runButton.textContent = "Run Python Code";
        }
      }
      
      async function loadCSV() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        
        if (!file) {
          addToOutput("Error: Please select a CSV file first.");
          return;
        }
        
        try {
          let pyodide = await pyodideReadyPromise;
          
          // Read file content
          const csvContent = await file.text();
          
          // Write file to Pyodide's virtual filesystem
          pyodide.FS.writeFile('uploaded_file.csv', csvContent);
          
          // Verify the file was loaded
          const verification = pyodide.runPython(`
import pandas as pd
try:
    df = pd.read_csv('uploaded_file.csv')
    f"CSV loaded successfully! Shape: {df.shape}, Columns: {list(df.columns)}"
except Exception as e:
    f"Error loading CSV: {e}"
          `);
          
          addToOutput(`File '${file.name}' uploaded as 'uploaded_file.csv'\n${verification}`);
          
        } catch (error) {
          addToOutput(`Error uploading CSV: ${error}`);
        }
      }
      
      // Allow Enter key to run code (Ctrl+Enter)
      code.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          evaluatePython();
        }
      });
    </script>
  </body>
</html>